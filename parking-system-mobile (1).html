<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="/manifest.json">
    <title>å³æ™‚åœè»Šç³»çµ±</title>
    <style>
        /* (ä¿æŒèˆ‡åŸæª”ç›¸åŒçš„ CSS) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #667eea; min-height: 100vh; padding: 10px; }
        .container { max-width: 400px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: #4CAF50; color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 20px; margin-bottom: 10px; }
        .location-info { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
        .content { padding: 20px; }
        .location-btn { width: 100%; background: #2196F3; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; margin-bottom: 15px; cursor: pointer; }
        .location-btn:active { background: #1976D2; }
        .location-btn:disabled { background: #ccc; }
        .parking-list { max-height: 400px; overflow-y: auto; }
        .parking-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #4CAF50; }
        .parking-item.full { border-left-color: #f44336; background: #ffebee; }
        .parking-item.limited { border-left-color: #ff9800; background: #fff3e0; }
        .parking-name { font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #333; }
        .parking-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .available-spots { font-size: 16px; font-weight: bold; }
        .available-spots.high { color: #4CAF50; }
        .available-spots.medium { color: #ff9800; }
        .available-spots.low { color: #f44336; }
        .distance { background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px; }
        .price-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; font-size: 13px; }
        .price-item { background: white; padding: 6px; border-radius: 4px; text-align: center; }
        .loading, .error { text-align: center; padding: 20px; margin: 10px 0; }
        .error { background: #ffebee; color: #c62828; border-radius: 8px; }
        .refresh-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: #4CAF50; color: white; border: none; border-radius: 50%; font-size: 18px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .refresh-btn:active { transform: scale(0.95); }
        .spinning { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-dot.high { background: #4CAF50; }
        .status-dot.medium { background: #ff9800; }
        .status-dot.low { background: #f44336; }
        .manual-location { background: #f5f5f5; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .section-title { font-weight: bold; margin-bottom: 10px; color: #333; font-size: 16px; }
        .input-group { margin-bottom: 10px; }
        .location-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; background: white; }
        .location-input:focus { outline: none; border-color: #2196F3; box-shadow: 0 0 5px rgba(33, 150, 243, 0.3); }
        .search-btn { width: 100%; background: #FF9800; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 5px; }
        .search-btn:active { background: #F57C00; }
        .search-btn:disabled { background: #ccc; }
        .toggle-section { text-align: center; margin-bottom: 15px; }
        .toggle-btn { background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 14px; cursor: pointer; }
        .toggle-btn:active { background: #7B1FA2; }
        .address-info { background: rgba(255,152,0,0.1); padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 14px; color: #E65100; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ…¿ï¸ å³æ™‚åœè»Šç³»çµ±</h1>
            <div class="location-info" id="locationInfo">
                ğŸ“ é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç²å–ä½ç½®
            </div>
        </div>

        <div class="content">
            <button class="location-btn" id="getLocationBtn">
                ğŸ“ ç²å–æˆ‘çš„ä½ç½®
            </button>

            <div class="manual-location" id="manualLocationSection" style="display: none;">
                <div class="section-title">ğŸ“ æ‰‹å‹•è¼¸å…¥ä½ç½®</div>
                <div class="input-group">
                    <select id="citySelect" class="location-input">
                        <option value="">é¸æ“‡åŸå¸‚</option>
                        <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
                        <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                        <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
                        <option value="å°å—å¸‚">å°å—å¸‚</option>
                        <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="text" id="districtInput" class="location-input" placeholder="è«‹è¼¸å…¥è¡Œæ”¿å€ (ä¾‹: ä¸­æ­£å€)">
                </div>
                <div class="input-group">
                    <input type="text" id="streetInput" class="location-input" placeholder="è«‹è¼¸å…¥è·¯å (ä¾‹: å¿ å­æ±è·¯)">
                </div>
                <button class="search-btn" id="searchByAddressBtn">
                    ğŸ” æœå°‹é™„è¿‘åœè»Šå ´
                </button>
            </div>

            <div class="toggle-section">
                <button class="toggle-btn" id="toggleManualBtn">
                    ğŸ”„ æ”¹ç”¨æ‰‹å‹•è¼¸å…¥ä½ç½®
                </button>
            </div>

            <div id="errorMessage"></div>
            <div id="loadingMessage"></div>
            <div id="parkingList" class="parking-list"></div>
        </div>
    </div>

    <button class="refresh-btn" id="refreshBtn">ğŸ”„</button>

    <script>
        let currentLocation = null;
        let parkingData = [];

        const cityCoordinates = {
            'å°åŒ—å¸‚': { lat: 25.0330, lng: 121.5654 },
            'æ–°åŒ—å¸‚': { lat: 25.0173, lng: 121.4467 },
            'æ¡ƒåœ’å¸‚': { lat: 24.9937, lng: 121.3009 },
            'å°ä¸­å¸‚': { lat: 24.1477, lng: 120.6736 },
            'å°å—å¸‚': { lat: 22.9999, lng: 120.2269 },
            'é«˜é›„å¸‚': { lat: 22.6273, lng: 120.3014 }
        };

        const districtOffsets = {
            'ä¸­æ­£å€': { lat: 0.005, lng: 0.005 },
            'å¤§åŒå€': { lat: 0.010, lng: -0.005 },
            'ä¸­å±±å€': { lat: 0.015, lng: 0.010 },
            'æ¾å±±å€': { lat: 0.020, lng: 0.015 },
            'å¤§å®‰å€': { lat: -0.005, lng: 0.010 },
            'è¬è¯å€': { lat: -0.010, lng: -0.010 },
            'ä¿¡ç¾©å€': { lat: 0.000, lng: 0.020 },
            'å£«æ—å€': { lat: 0.030, lng: 0.005 },
            'åŒ—æŠ•å€': { lat: 0.040, lng: -0.010 },
            'å…§æ¹–å€': { lat: 0.025, lng: 0.025 },
            'å—æ¸¯å€': { lat: 0.015, lng: 0.030 },
            'æ–‡å±±å€': { lat: -0.020, lng: 0.005 }
        };

        function initParkingData() {
            parkingData = [
                { id: 1, name: 'å°åŒ—è»Šç«™åœ°ä¸‹åœè»Šå ´', lat: 25.0478, lng: 121.5170, totalSpots: 200, availableSpots: 45, hourlyRate: 40, maxDailyRate: 240, height: 2.1, city: 'å°åŒ—å¸‚', district: 'ä¸­æ­£å€' },
                { id: 2, name: 'ä¿¡ç¾©å¨ç§€åœè»Šå ´', lat: 25.0360, lng: 121.5645, totalSpots: 150, availableSpots: 8, hourlyRate: 60, maxDailyRate: 360, height: 2.0, city: 'å°åŒ—å¸‚', district: 'ä¿¡ç¾©å€' },
                { id: 3, name: 'è¥¿é–€ç”ºåœè»Šå ´', lat: 25.0420, lng: 121.5070, totalSpots: 80, availableSpots: 0, hourlyRate: 50, maxDailyRate: 300, height: 1.9, city: 'å°åŒ—å¸‚', district: 'è¬è¯å€' },
                { id: 4, name: 'æ¾å±±æ©Ÿå ´åœè»Šå ´', lat: 25.0697, lng: 121.5514, totalSpots: 300, availableSpots: 120, hourlyRate: 30, maxDailyRate: 180, height: 2.2, city: 'å°åŒ—å¸‚', district: 'æ¾å±±å€' },
                { id: 5, name: 'å¤§å®‰æ£®æ—å…¬åœ’åœè»Šå ´', lat: 25.0329, lng: 121.5354, totalSpots: 100, availableSpots: 25, hourlyRate: 35, maxDailyRate: 210, height: 2.0, city: 'å°åŒ—å¸‚', district: 'å¤§å®‰å€' },
                { id: 6, name: 'æ¿æ©‹è»Šç«™åœè»Šå ´', lat: 25.0138, lng: 121.4627, totalSpots: 250, availableSpots: 89, hourlyRate: 35, maxDailyRate: 200, height: 2.1, city: 'æ–°åŒ—å¸‚', district: 'æ¿æ©‹å€' },
                { id: 7, name: 'æ¡ƒåœ’è»Šç«™åœè»Šå ´', lat: 24.9890, lng: 121.3135, totalSpots: 180, availableSpots: 56, hourlyRate: 30, maxDailyRate: 150, height: 2.0, city: 'æ¡ƒåœ’å¸‚', district: 'æ¡ƒåœ’å€' },
                { id: 8, name: 'å°ä¸­è»Šç«™åœè»Šå ´', lat: 24.1369, lng: 120.6839, totalSpots: 200, availableSpots: 78, hourlyRate: 25, maxDailyRate: 120, height: 2.1, city: 'å°ä¸­å¸‚', district: 'ä¸­å€' },
                { id: 9, name: 'å¿ å­å¾©èˆˆç«™åœè»Šå ´', lat: 25.0417, lng: 121.5440, totalSpots: 120, availableSpots: 34, hourlyRate: 50, maxDailyRate: 300, height: 2.0, city: 'å°åŒ—å¸‚', district: 'å¤§å®‰å€' },
                { id: 10, name: 'å¸‚æ”¿åºœç«™åœè»Šå ´', lat: 25.0408, lng: 121.5678, totalSpots: 160, availableSpots: 67, hourlyRate: 55, maxDailyRate: 330, height: 2.1, city: 'å°åŒ—å¸‚', district: 'ä¿¡ç¾©å€' },
                { id: 11, name: 'ä¸­å±±ç«™åœè»Šå ´', lat: 25.0525, lng: 121.5200, totalSpots: 90, availableSpots: 12, hourlyRate: 45, maxDailyRate: 270, height: 1.9, city: 'å°åŒ—å¸‚', district: 'ä¸­å±±å€' },
                { id: 12, name: 'æ·¡æ°´è€è¡—åœè»Šå ´', lat: 25.1677, lng: 121.4362, totalSpots: 150, availableSpots: 89, hourlyRate: 30, maxDailyRate: 150, height: 2.2, city: 'æ–°åŒ—å¸‚', district: 'æ·¡æ°´å€' },
                { id: 13, name: 'ä¹ä»½è€è¡—åœè»Šå ´', lat: 25.1095, lng: 121.8456, totalSpots: 80, availableSpots: 23, hourlyRate: 40, maxDailyRate: 200, height: 2.0, city: 'æ–°åŒ—å¸‚', district: 'ç‘èŠ³å€' },
                { id: 14, name: 'æ—å£ä¸‰äº•åœè»Šå ´', lat: 25.0770, lng: 121.3540, totalSpots: 300, availableSpots: 156, hourlyRate: 35, maxDailyRate: 180, height: 2.1, city: 'æ–°åŒ—å¸‚', district: 'æ—å£å€' },
                { id: 15, name: 'ä¸­å£¢è»Šç«™åœè»Šå ´', lat: 24.9537, lng: 121.2257, totalSpots: 180, availableSpots: 45, hourlyRate: 25, maxDailyRate: 120, height: 2.0, city: 'æ¡ƒåœ’å¸‚', district: 'ä¸­å£¢å€' },
                { id: 16, name: 'æ±å€åœ°ä¸‹è¡—åœè»Šå ´', lat: 25.0418, lng: 121.5313, totalSpots: 140, availableSpots: 28, hourlyRate: 45, maxDailyRate: 270, height: 2.0, city: 'å°åŒ—å¸‚', district: 'å¤§å®‰å€' },
                { id: 17, name: 'åœ‹çˆ¶ç´€å¿µé¤¨åœè»Šå ´', lat: 25.0400, lng: 121.5600, totalSpots: 200, availableSpots: 87, hourlyRate: 40, maxDailyRate: 240, height: 2.1, city: 'å°åŒ—å¸‚', district: 'ä¿¡ç¾©å€' },
                { id: 18, name: 'è¯å±±æ–‡å‰µåœ’å€åœè»Šå ´', lat: 25.0435, lng: 121.5292, totalSpots: 100, availableSpots: 15, hourlyRate: 50, maxDailyRate: 300, height: 1.9, city: 'å°åŒ—å¸‚', district: 'ä¸­æ­£å€' },
                { id: 19, name: 'å…‰è¯å•†å ´åœè»Šå ´', lat: 25.0456, lng: 121.5330, totalSpots: 80, availableSpots: 32, hourlyRate: 40, maxDailyRate: 240, height: 2.0, city: 'å°åŒ—å¸‚', district: 'ä¸­æ­£å€' },
                { id: 20, name: 'äº¬ç«™æ™‚å°šå»£å ´åœè»Šå ´', lat: 25.0490, lng: 121.5170, totalSpots: 160, availableSpots: 67, hourlyRate: 55, maxDailyRate: 330, height: 2.1, city: 'å°åŒ—å¸‚', district: 'å¤§åŒå€' },
                { id: 21, name: 'å—äº¬å¾©èˆˆç«™åœè»Šå ´', lat: 25.0520, lng: 121.5440, totalSpots: 120, availableSpots: 43, hourlyRate: 50, maxDailyRate: 300, height: 2.0, city: 'å°åŒ—å¸‚', district: 'ä¸­å±±å€' },
                { id: 22, name: 'æ°‘ç”Ÿç¤¾å€åœè»Šå ´', lat: 25.0580, lng: 121.5520, totalSpots: 90, availableSpots: 21, hourlyRate: 35, maxDailyRate: 210, height: 2.0, city: 'å°åŒ—å¸‚', district: 'æ¾å±±å€' },
                { id: 23, name: 'å¸«å¤§å¤œå¸‚åœè»Šå ´', lat: 25.0260, lng: 121.5280, totalSpots: 70, availableSpots: 8, hourlyRate: 45, maxDailyRate: 270, height: 1.9, city: 'å°åŒ—å¸‚', district: 'å¤§å®‰å€' },
                { id: 24, name: 'å…¬é¤¨å•†åœˆåœè»Šå ´', lat: 25.0150, lng: 121.5350, totalSpots: 110, availableSpots: 56, hourlyRate: 35, maxDailyRate: 210, height: 2.0, city: 'å°åŒ—å¸‚', district: 'ä¸­æ­£å€' },
                { id: 25, name: 'æ°¸åº·è¡—åœè»Šå ´', lat: 25.0320, lng: 121.5290, totalSpots: 60, availableSpots: 12, hourlyRate: 50, maxDailyRate: 300, height: 1.8, city: 'å°åŒ—å¸‚', district: 'å¤§å®‰å€' }
            ];
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getCurrentLocation() {
            const btn = document.getElementById('getLocationBtn');
            const locationInfo = document.getElementById('locationInfo');

            btn.disabled = true;
            btn.textContent = 'ğŸ“ å®šä½ä¸­...';
            showLoading('æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...');

            if (!navigator.geolocation) {
                showError('æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½');
                btn.disabled = false;
                btn.textContent = 'ğŸ“ ç²å–æˆ‘çš„ä½ç½®';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    locationInfo.innerHTML = 'ğŸ“ ä½ç½®å·²ç²å– (ç²¾ç¢ºåº¦: ' +
                        Math.round(position.coords.accuracy) + 'å…¬å°º)';

                    btn.textContent = 'âœ… ä½ç½®å·²ç²å–';
                    btn.disabled = false;
                    searchNearbyParking();
                },
                function(error) {
                    let errorMessage = 'ç„¡æ³•ç²å–ä½ç½®';
                    if (error.code === 1) { errorMessage = 'è«‹å…è¨±ä½ç½®å­˜å–æ¬Šé™'; }
                    else if (error.code === 2) { errorMessage = 'ä½ç½®è³‡è¨Šç„¡æ³•å–å¾—'; }
                    else if (error.code === 3) { errorMessage = 'å®šä½è«‹æ±‚é€¾æ™‚'; }

                    showError(errorMessage);
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“ é‡æ–°ç²å–ä½ç½®';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        }

        function searchNearbyParking() {
            if (!currentLocation) { showError('è«‹å…ˆç²å–ä½ç½®'); return; }
            showLoading('æœå°‹3å…¬é‡Œå…§åœè»Šå ´...');

            const parkingWithDistance = parkingData.map(parking => ({
                ...parking,
                distance: calculateDistance(currentLocation.lat, currentLocation.lng, parking.lat, parking.lng)
            })).filter(p => p.distance <= 3).sort((a, b) => a.distance - b.distance);

            setTimeout(() => {
                if (parkingWithDistance.length === 0) {
                    document.getElementById('parkingList').innerHTML =
                        '<div class="loading">3å…¬é‡Œå…§æ²’æœ‰æ‰¾åˆ°åœè»Šå ´<br><small>è«‹å˜—è©¦ç§»å‹•åˆ°å…¶ä»–ä½ç½®</small></div>';
                } else {
                    displayParkingList(parkingWithDistance);
                }
                hideLoading();
            }, 800);
        }

        function searchNearbyParkingByLocation() {
            if (!currentLocation) { showError('ç›®å‰æ²’æœ‰å¯ç”¨çš„ä½ç½®'); return; }
            showLoading('æ ¹æ“šæŒ‡å®šä½ç½®æœå°‹3å…¬é‡Œå…§åœè»Šå ´...');

            const list = parkingData.map(parking => ({
                ...parking,
                distance: calculateDistance(currentLocation.lat, currentLocation.lng, parking.lat, parking.lng)
            })).filter(p => p.distance <= 3).sort((a, b) => a.distance - b.distance);

            setTimeout(() => {
                if (list.length === 0) {
                    document.getElementById('parkingList').innerHTML =
                        '<div class="loading">3å…¬é‡Œå…§æ²’æœ‰æ‰¾åˆ°åœè»Šå ´</div>';
                } else {
                    displayParkingList(list);
                }
                hideLoading();
            }, 600);
        }

        function displayParkingList(parkingList) {
            const container = document.getElementById('parkingList');

            if (parkingList.length === 0) {
                container.innerHTML = '<div class="loading">é™„è¿‘æ²’æœ‰æ‰¾åˆ°åœè»Šå ´</div>';
                return;
            }

            container.innerHTML = parkingList.map(parking => {
                const ratio = parking.availableSpots / parking.totalSpots;
                let availabilityClass = 'high';
                let statusClass = '';

                if (parking.availableSpots === 0) {
                    availabilityClass = 'low';
                    statusClass = 'full';
                } else if (ratio < 0.2) {
                    availabilityClass = 'low';
                    statusClass = 'limited';
                } else if (ratio < 0.5) {
                    availabilityClass = 'medium';
                    statusClass = 'limited';
                }

                return `
                    <div class="parking-item ${statusClass}">
                        <div class="parking-name">
                            <span class="status-dot ${availabilityClass}"></span>
                            ${parking.name}
                        </div>
                        <div class="parking-info">
                            <div class="available-spots ${availabilityClass}">
                                ${parking.availableSpots}/${parking.totalSpots} è»Šä½
                            </div>
                            <div class="distance">
                                ${parking.distance < 1 ?
                                    Math.round(parking.distance * 1000) + 'm' :
                                    parking.distance.toFixed(1) + 'km'}
                            </div>
                        </div>
                        <div class="price-info">
                            <div class="price-item">
                                <strong>æ™‚ç§Ÿ</strong><br>
                                $${parking.hourlyRate}/å°æ™‚
                            </div>
                            <div class="price-item">
                                <strong>æ—¥ç§Ÿä¸Šé™</strong><br>
                                $${parking.maxDailyRate}
                            </div>
                            <div class="price-item">
                                <strong>è»Šé«˜é™åˆ¶</strong><br>
                                ${parking.height}m
                            </div>
                            <div class="price-item">
                                <strong>ç‹€æ…‹</strong><br>
                                ${parking.availableSpots === 0 ? 'å·²æ»¿' :
                                  parking.availableSpots < 20 ? 'å‰©é¤˜ä¸å¤š' : 'å……è¶³'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('spinning');

            parkingData.forEach(parking => {
                const change = Math.floor(Math.random() * 21) - 10;
                parking.availableSpots = Math.max(0, Math.min(parking.totalSpots, parking.availableSpots + change));
            });

            setTimeout(() => {
                const manualSection = document.getElementById('manualLocationSection');
                if (currentLocation) {
                    if (manualSection.style.display === 'block') searchNearbyParkingByLocation();
                    else searchNearbyParking();
                }
                refreshBtn.classList.remove('spinning');
            }, 1000);
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').innerHTML =
                '<div class="loading">' + message + '</div>';
            document.getElementById('errorMessage').innerHTML = '';
        }
        function hideLoading() { document.getElementById('loadingMessage').innerHTML = ''; }
        function showError(message) {
            document.getElementById('errorMessage').innerHTML =
                '<div class="error">' + message + '</div>';
            document.getElementById('loadingMessage').innerHTML = '';
        }

        function toggleManualInput() {
            const manualSection = document.getElementById('manualLocationSection');
            const toggleBtn = document.getElementById('toggleManualBtn');
            const gpsBtn = document.getElementById('getLocationBtn');

            if (manualSection.style.display === 'none') {
                manualSection.style.display = 'block';
                toggleBtn.textContent = 'ğŸ”„ æ”¹ç”¨GPSå®šä½';
                gpsBtn.style.display = 'none';
            } else {
                manualSection.style.display = 'none';
                toggleBtn.textContent = 'ğŸ”„ æ”¹ç”¨æ‰‹å‹•è¼¸å…¥ä½ç½®';
                gpsBtn.style.display = 'block';
            }
        }

        function searchByAddress() {
            const city = document.getElementById('citySelect').value;
            const district = document.getElementById('districtInput').value.trim();
            const street = document.getElementById('streetInput').value.trim();
            const locationInfo = document.getElementById('locationInfo');

            if (!city) { showError('è«‹é¸æ“‡åŸå¸‚'); return; }
            if (!district) { showError('è«‹è¼¸å…¥è¡Œæ”¿å€'); return; }

            showLoading('æ­£åœ¨æ ¹æ“šåœ°å€æœå°‹åœè»Šå ´...');

            const baseCoord = cityCoordinates[city];
            if (!baseCoord) { showError('ä¸æ”¯æ´çš„åŸå¸‚'); return; }

            let estimatedLat = baseCoord.lat;
            let estimatedLng = baseCoord.lng;

            const districtKey = Object.keys(districtOffsets).find(key =>
                district.includes(key.replace('å€', '')) || key.includes(district.replace('å€', ''))
            );

            if (districtKey) {
                const offset = districtOffsets[districtKey];
                estimatedLat += offset.lat;
                estimatedLng += offset.lng;
            } else {
                estimatedLat += (Math.random() - 0.5) * 0.02;
                estimatedLng += (Math.random() - 0.5) * 0.02;
            }

            currentLocation = { lat: estimatedLat, lng: estimatedLng };

            let addressText = city + district;
            if (street) addressText += street;

            locationInfo.innerHTML = `
                <div>ğŸ“ æ‰‹å‹•è¼¸å…¥ä½ç½®</div>
                <div class="address-info">
                    ${addressText}<br>
                    <small>é ä¼°åº§æ¨™: ${estimatedLat.toFixed(4)}, ${estimatedLng.toFixed(4)}</small>
                </div>
            `;

            setTimeout(() => { searchNearbyParkingByLocation(); }, 1000);
        }

        // è¨»å†Šäº‹ä»¶èˆ‡åˆå§‹åŒ–
        document.getElementById('getLocationBtn').addEventListener('click', getCurrentLocation);
        document.getElementById('refreshBtn').addEventListener('click', refreshData);
        document.getElementById('toggleManualBtn').addEventListener('click', toggleManualInput);
        document.getElementById('searchByAddressBtn').addEventListener('click', searchByAddress);

        initParkingData();

        // å¦‚æœæ”¯æ´ Service Workerï¼Œè¨»å†Šå®ƒï¼ˆç”¨æ–¼ PWA / é›¢ç·šå¿«å–ï¼‰
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(() => console.log('Service Worker å·²è¨»å†Š'))
                .catch(err => console.warn('Service Worker è¨»å†Šå¤±æ•—:', err));
        }
    </script>
</body>
</html>